//Készítette: Patika30

(function() {
    // --- Kombinált áttekintés (mode=combined + screen=overview_villages) ---
    var url = new URL(window.location.href);
    var base = url.origin + url.pathname; // .../game.php
    var params = url.searchParams;
    var village = params.get('village');

    var onCombined =
        params.get('screen') === 'overview_villages' &&
        params.get('mode') === 'combined';

    if (!onCombined) {
        if (!village) {
            alert('Nem található village paraméter az URL-ben!');
            return;
        }
        // Új, tiszta URL csak a szükséges paraméterekkel
        var newUrl = base + '?village=' + encodeURIComponent(village) +
                     '&screen=overview_villages&mode=combined';
        window.location.href = newUrl;
        return;
    }

    // ----- INNENTŐL JÖN AZ EGÉSZ INTERFACE + ÁTNEVEZŐ LOGIKA -----
    const uniqueId = 'falunev-atnevezo-gui-enter';
    if (document.getElementById(uniqueId)) {
        document.getElementById(uniqueId).style.zIndex = 10000;
        document.getElementById(uniqueId).style.display = 'block';
        return;
    }
    const storageKey = 'falunevAtnevezoConfig_enter_order';
    function getDefaultConfig() {
        return {
            order: ['num','cont','static'],
            useNum: true,
            startNum: 1,
            digits: 3,
            useCont: true,
            continentText: 'K',
            useStatic: true,
            staticText: 'Falunév'
        };
    }
    function saveConfig(cfg) { localStorage.setItem(storageKey, JSON.stringify(cfg)); }
    function loadConfig() {
        let stored = localStorage.getItem(storageKey);
        return stored ? JSON.parse(stored) : getDefaultConfig();
    }
    let cfg = loadConfig();

    function makeRow(type, cfg) {
        if (type === 'num') {
            return `<div class="crit-row" data-type="num" draggable="true" style="padding:5px 0;font-size:15px;display:flex;align-items:center;">
                <span class="drag-handle" style="cursor:move;margin-right:5px;">&#x2630;</span>
                <input type="checkbox" id="useNum" ${cfg.useNum ? 'checked' : ''} style="margin-right:4px;">Sorszám 
                <input type="number" id="startNum" value="${cfg.startNum}" style="width:47px;">
                <input type="number" id="digits" value="${cfg.digits}" style="width:34px;" min="1" max="6"> <small>Számhossz</small>
            </div>`;
        }
        if (type === 'cont') {
            return `<div class="crit-row" data-type="cont" draggable="true" style="padding:5px 0;font-size:15px;display:flex;align-items:center;">
                <span class="drag-handle" style="cursor:move;margin-right:5px;">&#x2630;</span>
                <input type="checkbox" id="useCont" ${cfg.useCont ? 'checked' : ''} style="margin-right:4px;">Kontinens:
                <input type="text" id="continentText" value="${cfg.continentText}" style="width:60px;" placeholder="K">
            </div>`;
        }
        if (type === 'static') {
            return `<div class="crit-row" data-type="static" draggable="true" style="padding:5px 0;font-size:15px;display:flex;align-items:center;">
                <span class="drag-handle" style="cursor:move;margin-right:5px;">&#x2630;</span>
                <input type="checkbox" id="useStatic" ${cfg.useStatic ? 'checked' : ''} style="margin-right:4px;">Falunév:
                <input type="text" id="staticText" value="${cfg.staticText}" style="width:120px;">
            </div>`;
        }
        return '';
    }

    function generatePreview(cfg, idx = 0) {
        var parts = [];
        cfg.order.forEach(type => {
            if (type === 'num' && cfg.useNum)
                parts.push(String(cfg.startNum + idx).padStart(cfg.digits || 3, '0'));
            if (type === 'cont' && cfg.useCont && cfg.continentText)
                parts.push(cfg.continentText);
            if (type === 'static' && cfg.useStatic && cfg.staticText)
                parts.push(cfg.staticText);
        });
        return parts.join(' ').trim();
    }

    function removeAllPlaceholders() {
        document.querySelectorAll('.sortable-placeholder').forEach(ph => ph.remove());
    }

    function buildGui(cfg) {
        var gui = document.createElement('div');
        gui.id = uniqueId;
        gui.style.cssText = 'position:fixed;top:60px;left:40px;z-index:10000;background:#f7eed3;border:2px ridge brown;width:440px;padding:0;box-shadow:0 4px 8px rgba(0,0,0,.2);';
        gui.innerHTML = `
        <div id="falunev-atnevezo-dragbar-enter" style="cursor:move;background:#dfcca6;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #c6ae78;">
            <span style="font-size:18px;">Tömeges faluátnevező</span>
            <button onclick="document.getElementById('${uniqueId}').remove()" style="font-size:16px;color:red;">×</button>
        </div>
        <div style="padding:16px;">
            <div id="critArea">
                ${cfg.order.map(x => makeRow(x, cfg)).join('')}
            </div>
            <div style="margin-top:12px;">
                <b>Előnézet:</b> <span id="previewFaluNev" style="background:#fffbe8;border:1px solid #dfcca6;padding:2px 12px;">${generatePreview(cfg)}</span>
            </div>
            <br>
            <div style="font-size:14px;color:#005;font-weight:bold;">Nyomva tartott Enterrel nevezi át egymás után a falvakat!</div>
            <div id="renameStatus" style="margin-top:8px;font-size:14px;color:green"></div>
            <div style="margin-top:16px;margin-bottom:3px;text-align:right;">
                <span style="color:#999;font-size:11px;font-family:Arial, sans-serif;">Készítette: Patika30</span>
            </div>
        </div>
        `;
        document.body.appendChild(gui);

        let dragBar = gui.querySelector('#falunev-atnevezo-dragbar-enter');
        let offsetX = 0, offsetY = 0, dragging = false;
        dragBar.addEventListener('mousedown', function(e) {
            dragging = true;
            offsetX = e.clientX - gui.offsetLeft;
            offsetY = e.clientY - gui.offsetTop;
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mouseup', function() { dragging = false; document.body.style.userSelect = ''; });
        document.addEventListener('mousemove', function(e) {
            if (dragging) {
                gui.style.left = (e.clientX - offsetX) + 'px';
                gui.style.top  = (e.clientY - offsetY) + 'px';
            }
        });

        function bindDragAndDrop() {
            let critArea = gui.querySelector('#critArea');
            let placeholder = document.createElement('div');
            placeholder.className = 'sortable-placeholder';
            placeholder.style.cssText = 'height:6px;background:#7c7c5c;margin:1px 0;border-radius:2px;';

            let draggingType = null, draggingEl = null, currentIndex = null;

            critArea.querySelectorAll('.crit-row').forEach((row, i) => {
                row.addEventListener('dragstart', function(e) {
                    removeAllPlaceholders();
                    draggingType = row.dataset.type;
                    draggingEl = row;
                    currentIndex = i;
                    e.dataTransfer.setData('text/plain', '');
                    setTimeout(() => row.style.visibility = "hidden", 10);
                });
                row.addEventListener('dragend', function(e) {
                    removeAllPlaceholders();
                    if (draggingEl) draggingEl.style.visibility = "";
                    draggingEl = null;
                });
                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    removeAllPlaceholders();
                    critArea.insertBefore(placeholder, row);
                });
                row.addEventListener('dragleave', function(e) {
                    removeAllPlaceholders();
                });
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    removeAllPlaceholders();
                    if (draggingEl) draggingEl.style.visibility = "";
                    let children = Array.from(critArea.children).filter(x => x !== placeholder);
                    let dropIndex = children.indexOf(row);
                    if (dropIndex > currentIndex) dropIndex--;
                    let newOrder = cfg.order.slice();
                    newOrder.splice(currentIndex, 1);
                    newOrder.splice(dropIndex, 0, draggingType);
                    cfg.order = newOrder;
                    saveConfig(cfg);
                    removeAllPlaceholders();
                    critArea.innerHTML = cfg.order.map(x => makeRow(x, cfg)).join('');
                    bindAll();
                    updatePreview();
                });
            });
            critArea.addEventListener('dragover', function(e){
                e.preventDefault();
                removeAllPlaceholders();
                if (!critArea.contains(placeholder)) critArea.appendChild(placeholder);
            });
        }

        function bindAll() {
            removeAllPlaceholders();
            bindDragAndDrop();
            let numRow = gui.querySelector('[data-type="num"]');
            if (numRow) {
                numRow.querySelector('#useNum').onchange = function() { cfg.useNum = this.checked; saveConfig(cfg); updatePreview(); };
                numRow.querySelector('#startNum').onchange = function() { cfg.startNum = parseInt(this.value,10)||1; saveConfig(cfg); updatePreview(); };
                numRow.querySelector('#digits').onchange = function() { cfg.digits = parseInt(this.value,10)||3; saveConfig(cfg); updatePreview(); };
            }
            let contRow = gui.querySelector('[data-type="cont"]');
            if (contRow) {
                contRow.querySelector('#useCont').onchange = function() { cfg.useCont = this.checked; saveConfig(cfg); updatePreview(); };
                contRow.querySelector('#continentText').oninput = function() { cfg.continentText = this.value; saveConfig(cfg); updatePreview(); };
            }
            let staticRow = gui.querySelector('[data-type="static"]');
            if (staticRow) {
                staticRow.querySelector('#useStatic').onchange = function() { cfg.useStatic = this.checked; saveConfig(cfg); updatePreview(); };
                staticRow.querySelector('#staticText').oninput = function() { cfg.staticText = this.value; saveConfig(cfg); updatePreview(); };
            }
        }
        bindAll();

        function updatePreview() {
            gui.querySelector('#previewFaluNev').innerText = generatePreview(cfg);
        }

        let enterHeld = false, idx = 0;
        let spans = [];
        document.addEventListener('keydown', function(e){
            if (e.key === 'Enter' && !enterHeld && document.getElementById(uniqueId)) {
                enterHeld = true;
                idx = 0;
                spans = Array.from(document.querySelectorAll('span.quickedit-vn'));
                nextRename();
            }
        });
        document.addEventListener('keyup', function(e){
            if (e.key === 'Enter' && enterHeld) { enterHeld = false; }
        });

        function nextRename() {
            if (!enterHeld || idx >= spans.length) {
                gui.querySelector('#renameStatus').innerText = `Átnevezés kész: ${idx} falu`;
                return;
            }
            let newName = generatePreview(cfg, idx).substring(0, 32);
            var span = spans[idx];
            if (!span) { idx++; setTimeout(nextRename, 320); return; }
            var curr =
                span.querySelector('input[type="text"]') ?
                    span.querySelector('input[type="text"]').value.trim() :
                (span.querySelector('.quickedit-content') ?
                    span.querySelector('.quickedit-content').innerText.trim() :
                    "");
            if (curr === newName) {
                idx++;
                setTimeout(nextRename, 80);
                return;
            }
            var icon = span.querySelector('.rename-icon');
            if (icon) icon.click();

            let tries = 0;
            function waitInputAndRename(){
                let input = span.querySelector('input[type="text"]');
                let btn = span.querySelector('button.btn-confirm-yes') ||
                          span.querySelector('input[type="button"]') ||
                          span.querySelector('button.btn-confirm') ||
                          span.querySelector('.btn-confirm-yes');
                if (input && btn) {
                    input.value = newName;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    btn.click();
                    gui.querySelector('#renameStatus').innerText = `${idx+1} falut átnevezett.`;
                    idx++;
                    setTimeout(nextRename, 320);
                } else {
                    tries++;
                    if (tries < 20) setTimeout(waitInputAndRename, 90);
                    else { idx++; setTimeout(nextRename, 320); }
                }
            }
            waitInputAndRename();
        }
    }

    buildGui(cfg);
})();
